include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - project: 'infrastructure/renovate-bot'
    file: 'renovate-config-validator.gitlab-ci.yml'
  - project: 'infrastructure/ci'
    file: 'templates/kaniko.gitlab-ci.yml'
  - project: 'infrastructure/ci'
    file: 'templates/trivy.gitlab-ci.yml'
  # # General Kaniko items at the moment
  # - /.gitlab-ci/kaniko.yml
  # # Lets try container scanning
  # - /.gitlab-ci/trivy.yml

stages:
 - build
 - test

build_container_image:
  extends: .kaniko_build
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH

build_container_latest_image:
  extends: .kaniko_build
  variables:
    CONTAINER_BUILD_DESTINATIONS: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

scan_container_image:
  extends: .trivy_scan
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
